{% extends 'contents/base.html' %}
{% load django_bootstrap5 humanize custom_pagination %}

{% block header %}{% endblock header %}


{% block content %}
<div class="container">
  <p>登録アイテム数：{{ paginator.count }}件</p>
  <p>今日は{{ today }}です</p>
  {% if query_object %}
  <table class="table">
    <thead>
      <tr>
        <th>No.</th>
        <th>アイテム名称：</th>
        <th>アイテム種類：</th>
        <th>シーン</th>
        <th>アイテムカラー：</th>
        <th>購入日：</th>
        <th>経過時間</th>
        <th>詳細へ：</th>
        <th>クローゼットを変える</th>
      </tr>
    </thead>
    <tbody>
      {% for item in page_object %}
      <tr>
        <td>{{ forloop.counter0 | add:page_object.start_index }}</td>
        <td>{{ item.item_name}}</td>
        <td>{{ item.get_item_type_display }}</td>
        <td>{{ item.get_occasion_display }}</td>
        <td>{{ item.get_item_color_display}}</td>
        <td>{{ item.purchase_date| date:"Y-m-d"}}</td>
        <td>{{ item.aging_date.days | intcomma }}日経過しています</td>
        <td><a href="{% url 'item_detail' item.pk %}"button class="btn btn-sm btn-primary" type="submit">詳細を見る</a></td>
        {#<td>{{ item.closet }}</td>#}
        <td>
          <select class="closet_location" item_id = "{{ item.pk }}">
            {% for closet in closet_list %}
            <option value="{{ closet.id }}" {% if item.closet.id == closet.id %}selected{% endif %}>{{ closet.closet_name }}</option>
            {% endfor %}
          </select>
        </td>
      </tr>
      {% endfor %}
    </tbody>
    {% else %}
    <p>まだアイテムが登録されていません</p>
    {% endif %}
</table>

<div class="pagination">
    <span class="step-links">
        {% if page_object.has_previous %}
            <a href="?{% url_replace request 'page' 1 %}">&laquo; 1ページ目に戻る</a>
            <a href="?{% url_replace request 'page' page_object.previous_page_number %}">前のページ</a>
        {% endif %}

        <span class="current">
            ページ {{ page_object.number }} / {{ page_object.paginator.num_pages }}.
        </span>

        {% if page_object.has_next %}
            <a href="?{% url_replace request 'page' page_object.next_page_number %}">次のページ</a>
            <a href="?{% url_replace request 'page' page_object.paginator.num_pages %}">最後のページ &raquo;</a>
        {% endif %}
    </span>
</div>
{% csrf_token %}

<script>
  const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    const selects = document.querySelectorAll('.closet_location');
    selects.forEach(el => el.addEventListener('change', event => { 
      console.log(event.target.value);
      console.log(event.target.getAttribute('item_id'))

      const data = { item_id: event.target.getAttribute('item_id'), closet_id: event.target.value };

      fetch("{% url 'closet_change' %}", {
        method: 'POST', 
        headers: {
          'X-CSRFToken': csrftoken,
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(data),
      })
      .then(response => response.json())
      .then(data => {
        console.log('Success:', data);
      })
      .catch((error) => {
        console.error('Error:', error);
      });

    }));
    

</script>


{% endblock content %}
